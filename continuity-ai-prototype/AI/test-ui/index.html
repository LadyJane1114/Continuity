<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Entity Extraction Test UI</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px;
    }
    .container { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 100%; max-width: 1200px; margin: 0 auto; padding: 40px; }
    h1 { color: #333; margin-bottom: 10px; text-align: center; }
    .subtitle { color: #666; text-align: center; margin-bottom: 30px; font-size: 14px; }
    .input-section { margin-bottom: 20px; }
    label { display: block; color: #555; font-weight: 600; margin-bottom: 8px; }
    textarea {
      width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px;
      font-size: 16px; font-family: inherit; resize: vertical; min-height: 200px; transition: border-color .3s;
    }
    textarea:focus { outline: none; border-color: #667eea; }
    .button-row { display: flex; gap: 10px; margin-bottom: 30px; }
    button { flex: 1; padding: 15px 30px; font-size: 16px; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; transition: all .3s; }
    #submitBtn { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color: white; }
    #submitBtn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102,126,234,.4); }
    #submitBtn:disabled { opacity: .6; cursor: not-allowed; }
    #clearBtn { background: #f0f0f0; color: #666; }
    #clearBtn:hover { background: #e0e0e0; }
    .response-section { background: #f8f9fa; border-radius: 10px; padding: 20px; min-height: 200px; }
    .response-label { color: #555; font-weight: 600; margin-bottom: 10px; }
    #response { color: #333; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; }
    .loading { color: #667eea; font-style: italic; }
    .error { color: #e74c3c; padding: 15px; background: #fee; border-radius: 8px; border-left: 4px solid #e74c3c; }
    .success { animation: fadeIn .5s; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
    .status-indicator { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:5px; }
    .status-online { background:#27ae60; box-shadow: 0 0 5px #27ae60; }
    .status-offline { background:#e74c3c; }
    .user-id-input { width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:8px; font-size:14px; margin-bottom:15px; }
    .entities-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:20px; margin-top:20px; }
    .entity-card { background:white; border:2px solid #e0e0e0; border-radius:12px; padding:20px; transition: all .3s; }
    .entity-card:hover { border-color:#667eea; box-shadow:0 5px 15px rgba(102,126,234,.2); }
    .entity-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #f0f0f0; }
    .entity-name { font-size:18px; font-weight:700; color:#333; }
    .entity-type { padding:4px 12px; border-radius:20px; font-size:12px; font-weight:600; text-transform:uppercase; }
    .type-character { background:#e3f2fd; color:#1976d2; }
    .type-object { background:#fff3e0; color:#f57c00; }
    .type-location { background:#e8f5e9; color:#388e3c; }
    .type-event { background:#fce4ec; color:#c2185b; }
    .type-organization { background:#f3e5f5; color:#7b1fa2; }
    .type-concept { background:#e0f2f1; color:#00796b; }
    .type-unknown { background:#f5f5f5; color:#757575; }
    .entity-aliases { margin-bottom:10px; font-size:14px; color:#666; }
    .entity-facts { margin-top:10px; }
    .fact-item { background:#f8f9fa; padding:8px; margin:5px 0; border-radius:6px; font-size:13px; }
    .fact-key { font-weight:600; color:#555; }
    .fact-value { color:#333; }
    .fact-time { font-size:11px; color:#999; margin-left:5px; }
    .entity-id { font-size:11px; color:#999; margin-top:10px; }
    .json-container { background:#1e1e1e; border-radius:10px; padding:20px; margin-top:20px; max-height:500px; overflow-y:auto; }
    .json-content { color:#d4d4d4; font-family:'Courier New', monospace; font-size:13px; white-space:pre-wrap; word-wrap:break-word; }
    .stats-bar { background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:20px; display:flex; justify-content:space-around; text-align:center; }
    .stat-item { flex:1; }
    .stat-number { font-size:32px; font-weight:700; color:#667eea; }
    .stat-label { font-size:12px; color:#666; text-transform:uppercase; margin-top:5px; }
    .time-input { width:200px; padding:10px; border:2px solid #e0e0e0; border-radius:8px; font-size:14px; }
    .input-row { display:flex; gap:15px; align-items:center; margin-bottom:15px; }
    .tab-container { margin-top:30px; }
    .tabs { display:flex; gap:10px; margin-bottom:20px; border-bottom:2px solid #e0e0e0; }
    .tab { padding:10px 20px; cursor:pointer; border:none; background:none; font-size:16px; font-weight:600; color:#666; border-bottom:3px solid transparent; transition: all .3s; }
    .tab.active { color:#667eea; border-bottom-color:#667eea; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìñ Story Entity Extractor</h1>
    <p class="subtitle">
      <span class="status-indicator" id="statusIndicator"></span>
      <span id="statusText">Connecting...</span>
    </p>

    <div class="input-section">
      <label for="storyText">Story Text</label>
      <textarea id="storyText" placeholder="Paste your story text here... The AI will extract characters, objects, locations, events, organizations, and concepts." autofocus></textarea>
    </div>

    <div class="input-row">
      <div>
        <label for="timeId">Time ID</label>
        <input type="text" id="timeId" class="time-input" placeholder="t_001" value="t_001" />
      </div>
    </div>

    <div class="button-row">
      <button id="submitBtn" onclick="extractEntities()">Extract Entities</button>
      <button id="clearBtn" onclick="clearAll()">Clear</button>
    </div>

    <div class="tab-container" id="resultsContainer" style="display: none;">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('cards')">Entity Cards</button>
        <button class="tab" onclick="switchTab('json')">JSON Data</button>
      </div>

      <div id="cardsTab" class="tab-content active">
        <div class="stats-bar" id="statsBar"></div>
        <div class="entities-container" id="entitiesContainer"></div>
      </div>

      <div id="jsonTab" class="tab-content">
        <div class="json-container">
          <pre class="json-content" id="jsonContent"></pre>
        </div>
      </div>
    </div>

    <div class="response-section" id="loadingSection">
      <div class="response-label">Status:</div>
      <div id="response">Waiting for story text...</div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:8002';
    let extractedEntities = [];

    // Healthcheck
    async function checkHealth() {
      try {
        const response = await fetch(`${API_BASE}/health`);
        if (response.ok) {
          document.getElementById('statusIndicator').className = 'status-indicator status-online';
          document.getElementById('statusText').textContent = 'Connected';
        } else {
          throw new Error('API not healthy');
        }
      } catch (error) {
        document.getElementById('statusIndicator').className = 'status-indicator status-offline';
        document.getElementById('statusText').textContent = 'Disconnected - Make sure API is running';
      }
    }

    async function extractEntities() {
      const storyText = document.getElementById('storyText').value.trim();
      const timeId = document.getElementById('timeId').value.trim() || 't_001';
      const responseDiv = document.getElementById('response');
      const submitBtn = document.getElementById('submitBtn');
      const loadingSection = document.getElementById('loadingSection');
      const resultsContainer = document.getElementById('resultsContainer');

      if (!storyText) {
        responseDiv.innerHTML = '<div class="error">Please enter some story text!</div>';
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Extracting...';
      responseDiv.innerHTML = '<div class="loading">üîç Analyzing story text and extracting entities...</div>';
      loadingSection.style.display = 'block';
      resultsContainer.style.display = 'none';

      try {
        const res = await fetch(`${API_BASE}/entities/extract`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: storyText, time_id: timeId })
        });

        if (!res.ok) {
          throw new Error(`API error: ${res.status}`);
        }

        const data = await res.json();
        extractedEntities = data.entities || [];

        loadingSection.style.display = 'none';
        resultsContainer.style.display = 'block';

        displayEntities(extractedEntities);
        displayJSON(data);

      } catch (error) {
        responseDiv.innerHTML = `
          <div class="error">
            <strong>Error:</strong> ${escapeHtml(error.message)}<br>
            Make sure the API is running at ${API_BASE}
          </div>
        `;
        loadingSection.style.display = 'block';
        resultsContainer.style.display = 'none';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Extract Entities';
      }
    }

    function displayEntities(entities) {
      const container = document.getElementById('entitiesContainer');
      const statsBar = document.getElementById('statsBar');

      if (!entities || entities.length === 0) {
        container.innerHTML = '<div class="error">No entities found in the text.</div>';
        statsBar.innerHTML = '';
        return;
      }

      // Stats
      const typeCount = {};
      entities.forEach(e => {
        const type = e.entityType || 'unknown';
        typeCount[type] = (typeCount[type] || 0) + 1;
      });

      statsBar.innerHTML = `
        <div class="stat-item">
          <div class="stat-number">${entities.length}</div>
          <div class="stat-label">Total Entities</div>
        </div>
        ${Object.entries(typeCount).map(([type, count]) => `
          <div class="stat-item">
            <div class="stat-number">${count}</div>
            <div class="stat-label">${escapeHtml(type)}s</div>
          </div>
        `).join('')}
      `;

      // Cards
      container.innerHTML = entities.map(entity => {
        const typeClass = `type-${entity.entityType || 'unknown'}`;
        const aliases = entity.aliases && entity.aliases.length > 0
          ? `<div class="entity-aliases">aka: ${entity.aliases.map(escapeHtml).join(', ')}</div>`
          : '';

        const facts = entity.facts && entity.facts.length > 0
          ? `<div class="entity-facts">
              ${entity.facts.map(f => `
                <div class="fact-item">
                  <span class="fact-key">Fact:</span>
                  <span class="fact-value">${escapeHtml(f.fact || '')}</span>
                  <span class="fact-time">
                    [${escapeHtml((f.method || 'rule').toUpperCase())} ‚Ä¢ conf=${(f.confidence ?? '').toString()} ‚Ä¢ ${escapeHtml((f.evidence?.timeId) || '')}]
                  </span>
                  ${f.sourceText ? `<div style="margin-top:4px;color:#777;font-size:11px;">‚Ü≥ <em>${escapeHtml(f.sourceText)}</em></div>` : ''}
                </div>
              `).join('')}
            </div>`
          : '';

        return `
          <div class="entity-card">
            <div class="entity-header">
              <div class="entity-name">${escapeHtml(entity.name || '')}</div>
              <div class="entity-type ${typeClass}">${escapeHtml(entity.entityType || 'unknown')}</div>
            </div>
            ${aliases}
            ${facts}
            <div class="entity-id">ID: ${escapeHtml(entity.id || '')} ‚Ä¢ v${escapeHtml(String(entity.version ?? '1'))}</div>
          </div>
        `;
      }).join('');
    }

    function displayJSON(data) {
      const jsonContent = document.getElementById('jsonContent');
      jsonContent.textContent = JSON.stringify(data, null, 2);
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(tab + 'Tab').classList.add('active');
    }

    function clearAll() {
      document.getElementById('storyText').value = '';
      document.getElementById('response').textContent = 'Waiting for story text...';
      document.getElementById('loadingSection').style.display = 'block';
      document.getElementById('resultsContainer').style.display = 'none';
      extractedEntities = [];
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = String(text ?? '');
      return div.innerHTML;
    }

    // Shortcuts + Health
    document.getElementById('storyText').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && e.ctrlKey) {
        e.preventDefault();
        extractEntities();
      }
    });

    checkHealth();
    setInterval(checkHealth, 30000);
  </script>
</body>
</html>